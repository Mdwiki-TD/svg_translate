{% extends "base.html" %}

{% block title %}{% if user_specific %}My Tasks{% else %}All Tasks{% endif %} Â· SVG Translate Bot{% endblock %}

{% block extra_css %}
{% endblock %}

{% set status_classes = {
    'Completed': 'success',
    'Failed': 'danger',
    'Skipped': 'warning',
    'Running': 'primary',
    'Pending': 'secondary',
    'Cancelled': 'warning',
    'error': 'danger'
} %}

{% block content %}
<div class="container">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div class="d-flex align-items-center gap-3">
            <h1 class="h3 mb-0">
                {% if user_specific and tasks_user %}
                {% if is_own_tasks %}
                My Tasks
                {% else %}
                {{ tasks_user }}'s Tasks
                {% endif %}
                {% else %}
                All Tasks
                {% endif %}
            </h1>
            {% if user_specific %}
            <a href="{{ url_for('tasks.tasks') }}" class="btn btn-sm btn-outline-secondary">View All Tasks</a>
            {% endif %}
        </div>
        <div class="row g-2 align-items-center">
            <div class="col-auto">
                <label class="form-label mb-0" for="status">Status</label>
            </div>
            <div class="col-auto">
                <select class="form-select" id="status" name="status">
                    <option value="">All statuses</option>
                    {% for status in available_statuses %}
                    <option value="{{ status }}">{{ status }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <div class="table-responsive">
        <table id="tasks-table" class="table table-striped table-hover align-middle" style="width:100%">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Task ID</th>
                    <th scope="col">Title</th>
                    <th scope="col">Status</th>
                    <!-- <th scope="col">Files Ready</th> -->
                    <!-- <th scope="col">Titles</th> -->
                    <th scope="col">Translations</th>
                    <th scope="col">Download</th>
                    <th scope="col">Inject</th>
                    <th scope="col">Upload</th>
                    <th scope="col">Created</th>
                    <!-- <th scope="col">Updated</th> -->
                    <th scope="col">User</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr>
                    <td>
                        {{ loop.index }}
                    </td>
                    <td>
                        <!-- <code title="{{ task.id }}"> -->
                        <a href="{{ url_for('tasks.task', task_id=task.id) }}" class="text-decoration-none"
                            title="{{ task.id }}">
                            {{ task.id[:10] }}...
                        </a>
                        <!-- </code> -->
                    </td>
                    <td class="text-break">
                        {{ task.title }}
                    </td>
                    <td>
                        <span
                            class="badge bg-{{ status_classes.get(task.status, 'secondary') }}">{{ task.status }}</span>
                    </td>
                    <!-- <td>{{ task.files_to_upload_count }}</td> -->
                    <!-- <td>{{ task.new_translations_count }}</td> -->
                    <!-- <td>{{ task.stages.get('titles', {}).get('message', '') }}</td> -->
                    <td>{{ task.stages.get('translations', {}).get('message', '') }}</td>
                    <td>{{ task.stages.get('download', {}).get('message', '') | safe}}</td>
                    <td>{{ task.stages.get('inject', {}).get('message', '') | safe}}</td>
                    <td>
                        <!-- {{ task.stages.get('upload', {}).get('message', '') | safe}} -->
                        Done: {{ task.get("results", {}).get('upload_result', {}).get('done', 0) }}<br>
                        Not Done: {{ task.get("results", {}).get('upload_result', {}).get('not_done', 0) }}
                    </td>

                    <td data-order="{{ task.created_at_sort }}">{{ task.created_at_display }}</td>
                    <!-- <td data-order="{{ task.updated_at_sort }}">{{ task.updated_at_display }}</td> -->
                    <td>
                        {% if task.username %}
                        <a href="{{ url_for('tasks.tasks', user=task.username) }}" class="text-decoration-none">
                            {{ task.username }}
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        let table = $('#tasks-table').DataTable({
            responsive: true,
            pageLength: 25,
            order: [[5, 'desc']],
            columnDefs: [
                { targets: 0, responsivePriority: 1 },
                { targets: 1, responsivePriority: 2 },
                { targets: [3, 4], className: 'text-center' }
            ]
        });
        $('#status').on('change', function () {
            table.column(2).search($(this).val()).draw();
        });
    });
</script>
{% endblock %}
